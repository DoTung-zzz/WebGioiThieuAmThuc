@model IEnumerable<WebGioiThieuAmThuc.Models.Specialty>

@{
    ViewData["Title"] = "Danh sách Đặc sản";
}

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">Danh sách Đặc sản</h1>
        <p class="lead text-muted">Khám phá ẩm thực đặc sắc từ khắp ba miền</p>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <form asp-action="Index" method="get">
                <div class="input-group shadow-sm">
                    <input type="text" name="searchString" class="form-control border-0" placeholder="Tìm kiếm đặc sản..." value="@ViewData["CurrentFilter"]">
                    <button class="btn btn-primary px-4" type="submit"><i class="fas fa-search me-2"></i>Tìm kiếm</button>
                </div>
            </form>
        </div>
        <div class="col-md-6 text-end">
            @if (Context.Session.GetString("UserId") != null)
            {
                <a asp-action="Create" class="btn btn-success btn-lg rounded-pill px-4 shadow-sm">
                    <i class="fas fa-plus me-2"></i>Đăng bài mới
                </a>
            }
        </div>
    </div>

    <div class="row g-4">
        @foreach (var item in Model) {
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm hover-card">
                    <div class="position-relative">
                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <img src="@item.ImageUrl" class="card-img-top" alt="@item.Name" style="height: 250px; object-fit: cover;">
                        }
                        else
                        {
                            <img src="https://via.placeholder.com/400x250?text=No+Image" class="card-img-top" alt="No Image" style="height: 250px; object-fit: cover;">
                        }
                        <span class="badge bg-primary position-absolute top-0 end-0 m-3">@item.Region?.RegionName</span>
                        @if (Context.Session.GetString("UserId") != null)
                        {
                            <button class="btn btn-sm position-absolute top-0 start-0 m-3 favorite-btn" 
                                    style="background: rgba(255,255,255,0.9); border: none;"
                                    data-specialty-id="@item.SpecialtyId"
                                    onclick="toggleFavorite(@item.SpecialtyId, this)">
                                <i class="far fa-heart text-danger"></i>
                            </button>
                        }
                        @if (item.Status == "pending")
                        {
                            <span class="badge bg-warning position-absolute bottom-0 start-0 m-3">Chờ duyệt</span>
                        }
                        else if (item.Status == "rejected")
                        {
                            <span class="badge bg-danger position-absolute bottom-0 start-0 m-3">Từ chối</span>
                        }
                    </div>
                    <div class="card-body">
                        <h5 class="card-title fw-bold">@item.Name</h5>
                        <p class="card-text text-muted text-truncate-3">@item.ShortDescription</p>
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>@(item.CreatedByNavigation?.Fullname ?? "Thành viên")
                            <span class="mx-1">•</span>
                            <i class="fas fa-calendar me-1"></i>@(item.CreatedAt?.ToString("dd/MM/yyyy"))
                        </small>
                    </div>
                    <div class="card-footer bg-white border-0">
                        <div class="d-flex gap-2 flex-wrap">
                            <a asp-action="Details" asp-route-id="@item.SpecialtyId" class="btn btn-primary btn-sm flex-grow-1">
                                <i class="fas fa-eye me-1"></i>Xem chi tiết
                            </a>
                            @if (Context.Session.GetString("UserId") != null && (Context.Session.GetString("UserId") == item.CreatedBy.ToString() || Context.Session.GetString("Role") == "admin"))
                            {
                                <a asp-action="Edit" asp-route-id="@item.SpecialtyId" class="btn btn-warning btn-sm">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a asp-action="Delete" asp-route-id="@item.SpecialtyId" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash"></i>
                                </a>
                            }
                            @if (Context.Session.GetString("Role") == "admin" && item.Status == "pending")
                            {
                                <form asp-action="Approve" asp-route-id="@item.SpecialtyId" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-check me-1"></i>Duyệt
                                    </button>
                                </form>
                                <form asp-action="Reject" asp-route-id="@item.SpecialtyId" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-secondary btn-sm">
                                        <i class="fas fa-times me-1"></i>Từ chối
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .hover-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
    }
    .text-truncate-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<script>
function toggleFavorite(specialtyId, button) {
    const icon = button.querySelector('i');
    const isFavorited = icon.classList.contains('fas');
    
    const url = isFavorited ? '/Favorites/Remove' : '/Favorites/Add';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'specialtyId=' + specialtyId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (isFavorited) {
                icon.classList.remove('fas');
                icon.classList.add('far');
            } else {
                icon.classList.remove('far');
                icon.classList.add('fas');
            }
        } else {
            if (data.message) alert(data.message);
        }
    });
}

// Load favorite status for all cards
document.addEventListener('DOMContentLoaded', function() {
    const buttons = document.querySelectorAll('.favorite-btn');
    buttons.forEach(button => {
        const specialtyId = button.dataset.specialtyId;
        fetch('/Favorites/Check?specialtyId=' + specialtyId)
            .then(response => response.json())
            .then(data => {
                if (data.isFavorited) {
                    const icon = button.querySelector('i');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                }
            });
    });
});
</script>

